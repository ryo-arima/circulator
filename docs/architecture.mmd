graph TB
    subgraph "Circulator - Distributed System Architecture"
        subgraph "Client Layer"
            CLI[CLI Client]
            WEB[Web Client]
            API_CLIENT[API Client]
            CLIENT_REPO[Client Repository]
        end

        subgraph "Server Layer"
            subgraph "HTTP API Gateway"
                REST[REST API Server]
                GRPC[gRPC Server]
            end
            
            subgraph "Server Instance 1"
                SC1[Server Controller 1]
                SU1[Server UseCase 1]
                SR1[Server Repository 1]
            end
            
            subgraph "Server Instance 2"
                SC2[Server Controller 2]
                SU2[Server UseCase 2]
                SR2[Server Repository 2]
            end
        end

        subgraph "Agent Layer"            
            subgraph "Agent Instance 1"
                A1[Agent Node 1]
                AC1[Agent Controller 1]
                AU1[Agent UseCase 1]
                AR1[Agent Repository 1]
                FS1[File System 1]
            end
            
            subgraph "Agent Instance 2"
                A2[Agent Node 2]
                AC2[Agent Controller 2]
                AU2[Agent UseCase 2]
                AR2[Agent Repository 2]
                FS2[File System 2]
            end
            
            subgraph "Agent Instance N"
                AN[Agent Node N]
                ACN[Agent Controller N]
                AUN[Agent UseCase N]
                ARN[Agent Repository N]
                FSN[File System N]
            end
        end

        subgraph "Infrastructure Layer"
            subgraph "Message Streaming"
                PULSAR[(Apache Pulsar)]
                TOPICS[Topics: Commands, Events, Reports, Notifications, Inter-Server]
            end
            
            subgraph "Data Storage"
                MYSQL[(MySQL Database)]
                TABLES[Tables: Agents, AgentInfo, SystemInfo, ServerInstances]
            end
        end

        subgraph "Configuration and Logging"
            MCP[MCode System]
            LOG[Centralized Logging]
            BASE_CONFIG[BaseConfig DI]
        end
    end

    %% Client to Server Communication
    CLI --> REST
    WEB --> REST
    API_CLIENT --> GRPC
    
    %% Client Internal Communication
    CLI --> CLIENT_REPO
    WEB --> CLIENT_REPO
    API_CLIENT --> CLIENT_REPO
    
    %% API Gateway to Server Controllers
    REST --> SC1
    REST --> SC2
    GRPC --> SC1
    GRPC --> SC2
    
    %% Server Internal Communication (Database Access)
    SR1 --> MYSQL
    SR2 --> MYSQL
    
    %% Agent to Server HTTP Communication
    A1 --> REST
    A2 --> REST
    AN --> REST
    
    %% Agent Internal Communication (Instance 1)
    A1 --> AC1
    AC1 --> AU1
    AU1 --> AR1
    AR1 --> FS1
    
    %% Agent Internal Communication (Instance 2)
    A2 --> AC2
    AC2 --> AU2
    AU2 --> AR2
    AR2 --> FS2
    
    %% Agent Internal Communication (Instance N)
    AN --> ACN
    ACN --> AUN
    AUN --> ARN
    ARN --> FSN
    
    %% Server Repository to Pulsar to REST API Server Controller
    SR1 -.->|Publish Events| PULSAR
    SR2 -.->|Publish Events| PULSAR
    PULSAR -.->|Server Events| REST
    
    %% Server Controller to UseCase to Repository Pulsar Chain
    SC1 --> SU1
    SU1 --> SR1
    SC2 --> SU2
    SU2 --> SR2
    
    %% Agent Repository to Pulsar to gRPC Server Agent Controller
    AR1 -.->|Agent Reports| PULSAR
    AR2 -.->|Agent Reports| PULSAR
    ARN -.->|Agent Reports| PULSAR
    PULSAR -.->|Agent Data| GRPC
    
    %% Client Repository to Pulsar to REST API
    CLIENT_REPO -.->|Client Events| PULSAR
    PULSAR -.->|System Status| REST
    
    %% Additional Pulsar Communication Patterns
    PULSAR -.->|Commands| AR1
    PULSAR -.->|Commands| AR2
    PULSAR -.->|Commands| ARN
    
    %% Server to Server Communication via Pulsar
    SR1 -.->|Inter-Server Sync| PULSAR
    SR2 -.->|Inter-Server Sync| PULSAR
    PULSAR -.->|Server Coordination| SR1
    PULSAR -.->|Server Coordination| SR2
    
    %% Configuration and Logging
    MCP --> LOG
    BASE_CONFIG --> SC1
    BASE_CONFIG --> SC2
    BASE_CONFIG --> AC1
    BASE_CONFIG --> AC2
    BASE_CONFIG --> ACN
    BASE_CONFIG --> SR1
    BASE_CONFIG --> SR2
    BASE_CONFIG --> AR1
    BASE_CONFIG --> AR2
    BASE_CONFIG --> ARN

    %% Styling
    classDef clientLayer fill:#e1f5fe,stroke:#01579b,stroke-width:2px
    classDef serverLayer fill:#f3e5f5,stroke:#4a148c,stroke-width:2px
    classDef agentLayer fill:#e8f5e8,stroke:#1b5e20,stroke-width:2px
    classDef infraLayer fill:#fff3e0,stroke:#e65100,stroke-width:2px
    classDef configLayer fill:#fce4ec,stroke:#880e4f,stroke-width:2px

    class CLI,WEB,API_CLIENT,CLIENT_REPO clientLayer
    class REST,GRPC,SC1,SU1,SR1,SC2,SU2,SR2 serverLayer
    class A1,A2,AN,AC1,AU1,AR1,AC2,AU2,AR2,ACN,AUN,ARN agentLayer
    class PULSAR,TOPICS,MYSQL,TABLES,FS1,FS2,FSN infraLayer
    class MCP,LOG,BASE_CONFIG configLayer